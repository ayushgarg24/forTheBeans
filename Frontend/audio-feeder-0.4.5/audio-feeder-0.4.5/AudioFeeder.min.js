!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b():"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?exports.AudioFeeder=b():a.AudioFeeder=b()}(this,function(){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){!function(){function b(a){this._options=a||{},this._backend=null}var d=(c(1),c(2)),e=c(4);b.prototype.rate=0,b.prototype.targetRate=0,b.prototype.channels=0,b.prototype.bufferSize=0,Object.defineProperty(b.prototype,"bufferDuration",{get:function(){return this.targetRate?this.bufferSize/this.targetRate:0}}),Object.defineProperty(b.prototype,"bufferThreshold",{get:function(){return this._backend?this._backend.bufferThreshold/this.targetRate:0},set:function(a){if(!this._backend)throw"Invalid state: AudioFeeder cannot set bufferThreshold before init";this._backend.bufferThreshold=Math.round(a*this.targetRate)}}),Object.defineProperty(b.prototype,"playbackPosition",{get:function(){if(this._backend){var a=this.getPlaybackState();return a.playbackPosition}return 0}}),Object.defineProperty(b.prototype,"durationBuffered",{get:function(){if(this._backend){var a=this.getPlaybackState();return a.samplesQueued/this.targetRate}return 0}}),Object.defineProperty(b.prototype,"muted",{get:function(){if(this._backend)return this._backend.muted;throw"Invalid state: cannot get mute before init"},set:function(a){if(!this._backend)throw"Invalid state: cannot set mute before init";this._backend.muted=a}}),b.prototype.mute=function(){this.muted=!0},b.prototype.unmute=function(){this.muted=!1},Object.defineProperty(b.prototype,"volume",{get:function(){if(this._backend)return this._backend.volume;throw"Invalid state: cannot get volume before init"},set:function(a){if(!this._backend)throw"Invalid state: cannot set volume before init";this._backend.volume=a}}),b.prototype.init=function(a,b){if(this.channels=a,this.rate=b,d.isSupported())this._backend=new d(a,b,this._options);else{if(!e.isSupported())throw"No supported backend";this._backend=new e(a,b,this._options)}this.targetRate=this._backend.rate,this.bufferSize=this._backend.bufferSize,this._backend.onstarved=function(){this.onstarved&&this.onstarved()}.bind(this),this._backend.onbufferlow=function(){this.onbufferlow&&this.onbufferlow()}.bind(this)},b.prototype._resample=function(a){var b=this.rate,c=this.channels,d=this._backend.rate,e=this._backend.channels;if(b==d&&c==e)return a;for(var f=[],g=0;e>g;g++){var h=g;g>=c&&(h=0);for(var i=a[h],j=new Float32Array(Math.round(i.length*d/b)),k=0;k<j.length;k++)j[k]=i[k*b/d|0];f.push(j)}return f},b.prototype.bufferData=function(a){if(!this._backend)throw"Invalid state: AudioFeeder cannot bufferData before init";var b=this._resample(a);this._backend.appendBuffer(b)},b.prototype.getPlaybackState=function(){if(this._backend)return this._backend.getPlaybackState();throw"Invalid state: AudioFeeder cannot getPlaybackState before init"},b.prototype.waitUntilReady=function(a){if(!this._backend)throw"Invalid state: AudioFeeder cannot waitUntilReady before init";this._backend.waitUntilReady(a)},b.prototype.start=function(){if(!this._backend)throw"Invalid state: AudioFeeder cannot start before init";this._backend.start()},b.prototype.stop=function(){if(!this._backend)throw"Invalid state: AudioFeeder cannot stop before init";this._backend.stop()},b.prototype.flush=function(){if(!this._backend)throw"Invalid state: AudioFeeder cannot flush before init";this._backend.flush()},b.prototype.close=function(){this._backend&&(this._backend.close(),this._backend=null)},b.prototype.onstarved=null,b.prototype.onbufferlow=null,b.isSupported=function(){return!!Float32Array&&(d.isSupported()||e.isSupported())},b.initSharedAudioContext=function(){return d.isSupported()?d.initSharedAudioContext():null},a.exports=b}()},function(a,b){function c(a,b){if(1>a||a!==Math.round(a))throw"Invalid channel count for BufferQueue";this.channels=a,this.bufferSize=b,this.flush()}c.prototype.flush=function(){this._buffers=[],this._pendingBuffer=this.createBuffer(this.bufferSize),this._pendingPos=0},c.prototype.sampleCount=function(){var a=0;return this._buffers.forEach(function(b){a+=b[0].length}),a},c.prototype.createBuffer=function(a){for(var b=[],c=0;c<this.channels;c++)b[c]=new Float32Array(a);return b},c.prototype.validate=function(a){if(a.length!==this.channels)return!1;for(var b,c=0;c<a.length;c++){var d=a[c];if(!(d instanceof Float32Array))return!1;if(0==c)b=d.length;else if(d.length!==b)return!1}return!0},c.prototype.appendBuffer=function(a){if(!this.validate(a))throw"Invalid audio buffer passed to BufferQueue.appendBuffer";for(var b=a[0],c=b.length,d=0;c>d;d++){for(var e=0;e<this.channels;e++)this._pendingBuffer[e][this._pendingPos]=a[e][d];++this._pendingPos==this.bufferSize&&(this._buffers.push(this._pendingBuffer),this._pendingPos=0,this._pendingBuffer=this.createBuffer(this.bufferSize))}},c.prototype.prependBuffer=function(a){if(!this.validate(a))throw"Invalid audio buffer passed to BufferQueue.prependBuffer";var b=this._buffers.slice(0);b.push(this.trimBuffer(this._pendingBuffer,0,this._pendingPos)),this.flush(),this.appendBuffer(a);for(var c=0;c<b.length;c++)this.appendBuffer(b[c])},c.prototype.nextBuffer=function(){if(this._buffers.length)return this._buffers.shift();var a=this.trimBuffer(this._pendingBuffer,0,this._pendingPos);return this._pendingBuffer=this.createBuffer(this.bufferSize),this._pendingPos=0,a},c.prototype.trimBuffer=function(a,b,c){var d=a[0].length,e=b+Math.min(c,d);if(0==b&&e>=d)return a;for(var f=[],g=0;g<this.channels;g++)f[g]=a[g].subarray(b,e);return f},a.exports=c},function(a,b,c){!function(){function b(a,c,d){var f=d.audioContext||b.initSharedAudioContext();if(this._context=f,this.output=d.output||f.destination,this.rate=f.sampleRate,this.channels=Math.min(a,2),d.bufferSize&&(this.bufferSize=0|d.bufferSize),this.bufferThreshold=2*this.bufferSize,this._bufferQueue=new e(this.channels,this.bufferSize),this._playbackTimeAtBufferTail=f.currentTime,this._queuedTime=0,this._delayedTime=0,this._dropped=0,this._liveBuffer=this._bufferQueue.createBuffer(this.bufferSize),f.createScriptProcessor)this._node=f.createScriptProcessor(this.bufferSize,0,this.channels);else{if(!f.createJavaScriptNode)throw new Error("Bad version of web audio API?");this._node=f.createJavaScriptNode(this.bufferSize,0,this.channels)}}var d=window.AudioContext||window.webkitAudioContext,e=c(1),f=c(3);b.prototype.bufferSize=4096,b.prototype.bufferThreshold=8192,b.prototype._volume=1,Object.defineProperty(b.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=+a}}),b.prototype._muted=!1,Object.defineProperty(b.prototype,"muted",{get:function(){return this._muted},set:function(a){this._muted=!!a}}),b.prototype._audioProcess=function(a){var b,c,d,e,g;g="number"==typeof a.playbackTime?a.playbackTime:this._context.currentTime+this.bufferSize/this.rate;var h=this._playbackTimeAtBufferTail;if(g>h&&(this._delayedTime+=g-h),this._bufferQueue.sampleCount()<this.bufferSize&&this.onstarved&&this.onstarved(),this._bufferQueue.sampleCount()<this.bufferSize){for(b=0;b<this.channels;b++)for(d=a.outputBuffer.getChannelData(b),e=0;e<this.bufferSize;e++)d[e]=0;return void this._dropped++}var i=this.muted?0:this.volume,j=this._bufferQueue.nextBuffer();if(j[0].length<this.bufferSize)throw"Audio buffer not expected length.";for(b=0;b<this.channels;b++)for(c=j[b],this._liveBuffer[b].set(j[b]),d=a.outputBuffer.getChannelData(b),e=0;e<c.length;e++)d[e]=c[e]*i;this._queuedTime+=this.bufferSize/this.rate,this._playbackTimeAtBufferTail=g+this.bufferSize/this.rate,this._bufferQueue.sampleCount()<Math.max(this.bufferSize,this.bufferThreshold)&&this.onbufferlow&&f(this.onbufferlow.bind(this))},b.prototype._samplesQueued=function(){var a=this._bufferQueue.sampleCount(),b=Math.floor(this._timeAwaitingPlayback()*this.rate);return a+b},b.prototype._timeAwaitingPlayback=function(){return Math.max(0,this._playbackTimeAtBufferTail-this._context.currentTime)},b.prototype.getPlaybackState=function(){return{playbackPosition:this._queuedTime-this._timeAwaitingPlayback(),samplesQueued:this._samplesQueued(),dropped:this._dropped,delayed:this._delayedTime}},b.prototype.waitUntilReady=function(a){a()},b.prototype.appendBuffer=function(a){this._bufferQueue.appendBuffer(a)},b.prototype.start=function(){this._node.onaudioprocess=this._audioProcess.bind(this),this._node.connect(this.output),this._playbackTimeAtBufferTail=this._context.currentTime},b.prototype.stop=function(){if(this._node){var a=this._timeAwaitingPlayback();if(a>0){var b=Math.round(a*this.rate),c=this._liveBuffer?this._liveBuffer[0].length:0;b>c?(this._bufferQueue.prependBuffer(this._liveBuffer),this._bufferQueue.prependBuffer(this._bufferQueue.createBuffer(b-c))):this._bufferQueue.prependBuffer(this._bufferQueue.trimBuffer(this._liveBuffer,c-b,b)),this._playbackTimeAtBufferTail-=a}this._node.onaudioprocess=null,this._node.disconnect()}},b.prototype.flush=function(){this._bufferQueue.flush()},b.prototype.close=function(){this.stop(),this._context=null},b.prototype.onstarved=null,b.prototype.onbufferlow=null,b.isSupported=function(){return!!d},b.sharedAudioContext=null,b.initSharedAudioContext=function(){if(!b.sharedAudioContext&&b.isSupported()){var a,c=new d;if(c.createScriptProcessor)a=c.createScriptProcessor(1024,0,2);else{if(!c.createJavaScriptNode)throw new Error("Bad version of web audio API?");a=c.createJavaScriptNode(1024,0,2)}a.connect(c.destination),a.disconnect(),b.sharedAudioContext=c}return b.sharedAudioContext},a.exports=b}()},function(a,b){a.exports=function(){if("undefined"!=typeof window.setImmediate)return window.setImmediate;if(window&&window.postMessage){var a=[];return window.addEventListener("message",function(b){if(b.source===window){var c=b.data;if("object"==typeof c&&c.nextTickBrowserPingMessage){var d=a.pop();d&&d()}}}),function(b){a.push(b),window.postMessage({nextTickBrowserPingMessage:!0},document.location.toString())}}return function(a){setTimeout(a,0)}}()},function(a,b,c){!function(){function b(a){for(var b=new Uint8Array(a),c="",d=b.length,e=0;d>e;e++)c+=i[b[e]];return c}function d(a){return this instanceof arguments.callee?void("function"==typeof this.init&&this.init.apply(this,a&&a.callee?a:arguments)):new arguments.callee(arguments)}var e=c(5),f=c(3),g=function(a,b,c){c=c||{};var g={};"string"==typeof c.base&&(g.swf=c.base+"/"+e),c.bufferSize&&(this.bufferSize=0|c.bufferSize),this._flashaudio=new d(g),this._flashBuffer="",this._flushTimeout=null,this._cachedFlashState=null,this._cachedFlashTime=0,this._cachedFlashInterval=40,this._waitUntilReadyQueue=[],this.onready=function(){for(this._flashaudio.flashElement.setBufferSize(this.bufferSize),this._flashaudio.flashElement.setBufferThreshold(this.bufferThreshold);this._waitUntilReadyQueue.length;){var a=this._waitUntilReadyQueue.shift();a.apply(this)}},this.onlog=function(a){console.log("AudioFeeder FlashBackend: "+a)},this.bufferThreshold=2*this.bufferSize;var h={ready:"sync",log:"sync",starved:"sync",bufferlow:"async"};this._callbackName="AudioFeederFlashBackendCallback"+this._flashaudio.id;window[this._callbackName]=function(a){var b=h[a],c=this["on"+a];b&&c&&("async"===b?f(c.bind(this)):(c.apply(this,Array.prototype.slice.call(arguments,1)),this._flushFlashBuffer()))}.bind(this)};g.prototype.rate=44100,g.prototype.channels=2,g.prototype.bufferSize=4096,g.prototype._bufferThreshold=8192,Object.defineProperty(g.prototype,"bufferThreshold",{get:function(){return this._bufferThreshold},set:function(a){this._bufferThreshold=0|a,this.waitUntilReady(function(){this._flashaudio.flashElement.setBufferThreshold(this._bufferThreshold)}.bind(this))}}),g.prototype._volume=1,Object.defineProperty(g.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=+a,this.waitUntilReady(this._flashVolumeUpdate.bind(this))}}),g.prototype._muted=!1,Object.defineProperty(g.prototype,"muted",{get:function(){return this._muted},set:function(a){this._muted=!!a,this.waitUntilReady(this._flashVolumeUpdate.bind(this))}}),g.prototype._paused=!0,g.prototype._flashVolumeUpdate=function(){this._flashaudio&&this._flashaudio.flashElement&&this._flashaudio.flashElement.setVolume&&this._flashaudio.flashElement.setVolume(this.muted?0:this.volume)},g.prototype._resampleFlash=function(a){for(var b=1,c=a[0].length,d=new Int16Array(2*c),e=a[0],f=this.channels>1?a[1]:e,g=this.muted?0:this.volume,h=16384*g,i=0;c>i;i++){var j=i*b|0,k=2*i;d[k]=e[j]*h,d[k+1]=f[j]*h}return d};for(var h=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],i=[],j=0;256>j;j++)i[j]=h[15&j]+h[(240&j)>>4];g.prototype._flushFlashBuffer=function(){var a=this._flashBuffer,b=this._flashaudio.flashElement;this._cachedFlashState&&(this._cachedFlashState.samplesQueued+=a.length/8),this._flashBuffer="",this._flushTimeout=null,a.length>0&&this.waitUntilReady(function(){b.write(a)})},g.prototype.appendBuffer=function(a){var c=this._resampleFlash(a);if(c.length>0){var d=b(c.buffer);this._flashBuffer+=d,this._flushTimeout||(this._flushTimeout=!0,f(this._flushFlashBuffer.bind(this)))}},g.prototype.getPlaybackState=function(){if(this._flashaudio&&this._flashaudio.flashElement&&this._flashaudio.flashElement.write){var a,b=Date.now(),c=this._paused?0:b-this._cachedFlashTime;if(this._cachedFlashState&&c<this._cachedFlashInterval){var d=this._cachedFlashState;a={playbackPosition:d.playbackPosition+c/1e3,samplesQueued:d.samplesQueued-Math.max(0,Math.round(c*this.rate/1e3)),dropped:d.dropped,delayed:d.delayed}}else a=this._flashaudio.flashElement.getPlaybackState(),this._cachedFlashState=a,this._cachedFlashTime=b;return a.samplesQueued+=this._flashBuffer.length/8,a}return{playbackPosition:0,samplesQueued:0,dropped:0,delayed:0}},g.prototype.waitUntilReady=function(a){this._flashaudio&&this._flashaudio.flashElement.write?a.apply(this):this._waitUntilReadyQueue.push(a)},g.prototype.start=function(){this._flashaudio.flashElement.start(),this._paused=!1,this._cachedFlashState=null},g.prototype.stop=function(){this._flashaudio.flashElement.stop(),this._paused=!0,this._cachedFlashState=null},g.prototype.flush=function(){this._flashaudio.flashElement.flush(),this._cachedFlashState=null},g.prototype.close=function(){this.stop();var a=this._flashaudio.flashWrapper;a.parentNode.removeChild(a),this._flashaudio=null,delete window[this._callbackName]},g.prototype.onstarved=null,g.prototype.onbufferlow=null,g.isSupported=function(){if(-1!==navigator.userAgent.indexOf("Trident"))try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash");return!0}catch(a){return!1}return!1},d.nextId=1,d.prototype={nextId:null,swf:e,flashWrapper:null,flashElement:null,init:function(a){var b=this;b.id=d.nextId++,a&&"undefined"!=typeof a.swf&&(b.swf=a.swf),b.flashWrapper=document.createElement("div"),b.flashWrapper.id="dynamicaudio-flashwrapper-"+b.id;var c=b.flashWrapper.style;c.position="fixed",c.width="11px",c.height="11px",c.bottom=c.left="0px",c.overflow="hidden",b.flashElement=document.createElement("div"),b.flashElement.id="dynamicaudio-flashelement-"+b.id,b.flashWrapper.appendChild(b.flashElement),document.body.appendChild(b.flashWrapper);var e=b.flashElement.id,f='<param name="FlashVars" value="objectId='+b.id+'">';b.flashWrapper.innerHTML="<object id='"+e+"' width='10' height='10' type='application/x-shockwave-flash' data='"+b.swf+"' style='visibility: visible;'><param name='allowscriptaccess' value='always'>"+f+"</object>",b.flashElement=document.getElementById(e)}},a.exports=g}()},function(a,b,c){a.exports=c.p+"dynamicaudio.swf?version=e187c46551bc31edb18fea80fdc3e941"}])});